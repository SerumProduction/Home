<!DOCTYPE html>
<html>
<head>
    <title>The Coma</title>
    <script src="https://cdn.rawgit.com/mrdoob/three.js/r84/build/three.min.js"></script>
    <script src="http://sdk.altvr.com/libs/altspace.js/2.0.3/altspace.min.js"></script>
    <script src="http://cdn.rawgit.com/norybiak/UltimateLoader/v0.3.1/dist/UltimateLoader.js"></script>
    <script src="http://cdn.rawgit.com/oOblik/AltspaceVR-Native-Components-JS/0.1.2/js/JSNativeComponents.js"></script>
    <script src="config.js"></script>
    <script src="scattered_objects.js"></script>
    <script src="local_utils.js"></script>
    <script src="../common/utils.js"></script>
    <script>
        var root;
        var rootOffset = new THREE.Vector3(0, 0, 0);
        var skeleton;
        var head;
        var random = new RNG(new Date().getTime());
        var isMobile;

        ///////////////////////////////
        // INIT
        ///////////////////////////////
        function init()
        {
            // Setup ThreeJS Scene for AltspaceVR
            sim = new altspace.utilities.Simulation();

            root = new THREE.Object3D();
            root.position.add(rootOffset);
            sim.scene.add(root);

            var promises = [
                altspace.getEnclosure(),
                altspace.getThreeJSTrackingSkeleton(),
            ];

            Promise.all(promises).then(function (array)
            {
                enclosure = array.shift();
                skeleton = array.shift();

                enclosure.requestFullspace();

                sim.scene.add(skeleton);
                head = skeleton.getJoint('Head');

                isMobile = (/Mobile/i.test(navigator.userAgent)) ? true : false;
                LoadAssets();

            });

        }

        function LoadAssets()
        {
            ////////////////////////////
            // SKELETON and ATTACHMENTS
            ////////////////////////////

            // debug position display
            // head.addBehavior(DebugPosition());

            // black fog
            var fogLayers = isMobile ? 0 : 0;
            var fogMinDistance = isMobile ? 0 : 0;

            head.add(GetFog({ layers: fogLayers, minDistance: fogMinDistance, maxDistance: 100, color: new THREE.Color(0x000000) }));


            /////////////////
            // MAIN ASSETS
            ///////////////////

            // Sky - with the fog on it's really never seen
            root.add(GetSky());

            // Ground
            new NativeComponent('n-mesh-collider', { convex: false }, GetGround()).addTo(root);

            // horror
            AddHorror();

            // clouds
            AddClouds();


            // horror alter
            for (var i = 0; i < assets.alter.length; i++)
            {
                AddStandardMeshObject(assets.alter[i].path, assets.alter[i]);
            }

            // positioned trypos (hi poly)
            for (var i = 0; i < assets.trypos.length; i++)
            {
                AddStandardMeshObject('models/trypo.gltf', assets.trypos[i]);
            }

            // scattered trypos (lo poly)
            for (var i = 0; i < scattered_trypos.length; i++)
            {
                AddStandardMeshObject('models/trypo_lo.gltf', scattered_trypos[i]);
            }


            // scattered tooth clusters
            for (var i = 0; i < scattered_clusters.length; i++)
            {
                AddStandardMeshObject('models/toothcluster.gltf', scattered_clusters[i]);
            }

            // rotten teeth
            for (var i = 0; i < assets.rottenTeeth.length; i++)
            {
                AddStandardMeshObject('models/rottentooth.gltf', assets.rottenTeeth[i]);
            }

            // broken teeth 
            for (var i = 0; i < assets.brokenTeeth.length; i++)
            {
                AddStandardMeshObject('models/brokentooth.gltf', assets.brokenTeeth[i]);
            }

            //AddScaffold(new THREE.Vector3(0, 130, 0));

            //////////////////////////////
            // SOUNDS
            //////////////////////////////

		    for (var i = 0; i < assets.soundSources.length; i++)
		    {
		        var soundSource = assets.soundSources[i];
		        var config = assets.soundConfigs[soundSource.soundConfig];
		        if (soundSource.override !== 'undefined') {
		            for (var prop in soundSource.override) {
		                config[prop] = soundSource.override[prop];
		            }
		        }

				addSoundSource(config, assets.soundSources[i].p);
		    }
        }
    </script>
</head>
<body onload='init()'>
</body>
</html> 